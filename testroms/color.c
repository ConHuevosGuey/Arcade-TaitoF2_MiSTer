#include "color.h"
#include "system.h"

void set_palettes(uint16_t pal_index, uint16_t pal_count, uint16_t *colors)
{
    uint16_t offset = pal_index * 16;
    uint16_t count = pal_count * 16;

#if HAS_TC0110PCR
    for( uint16_t i = 0; i < count * 16; i++ )
    {
        *TC0110PCR_ADDR = (offset + i) * 2;
        *TC0110PCR_DATA = colors[i];
    }
    *TC0110PCR_WHAT = 0;
#endif

#if HAS_TC0260DAR
    for( uint16_t i = 0; i < count; i++ )
    {
        TC0260DAR[offset + i] = colors[i];
    }
#endif
}

static void gradient(uint8_t r0, uint8_t g0, uint8_t b0, uint8_t r1, uint8_t g1, uint8_t b1,
                     uint16_t *colors, uint16_t count)
{
    int8_t rd = (r1 - r0) / count;
    int8_t gd = (g1 - g0) / count;
    int8_t bd = (b1 - b0) / count;
        
    for( int i = 0; i < count - 1; i++ )
    {
        colors[i] = RGB_x555(r0, g0, b0);
        r0 += rd;
        g0 += gd;
        b0 += bd;
    }

    colors[count - 1] = RGB_x555(r1, g1, b1);
}

void set_gradient2(uint16_t pal_index, uint8_t r0, uint8_t g0, uint8_t b0,
                                       uint8_t r1, uint8_t g1, uint8_t b1)
{
    uint16_t colors[16];

    colors[0] = RGB_x555(0, 0, 0);

    gradient(r0, g0, b0, r1, g1, b1, &colors[1], 15);

    set_palettes(pal_index, 1, colors);
}

void set_gradient3(uint16_t pal_index, uint8_t r0, uint8_t g0, uint8_t b0,
                                       uint8_t r1, uint8_t g1, uint8_t b1,
                                       uint8_t r2, uint8_t g2, uint8_t b2)
{
    uint16_t colors[16];
    
    colors[0] = RGB_x555(0, 0, 0);
    gradient(r0, g0, b0, r1, g1, b1, &colors[1], 8);
    gradient(r1, g1, b1, r2, g2, b2, &colors[8], 8);

    set_palettes(pal_index, 1, colors);
}

static uint16_t x444_palette[] =
{
    0x0000, 0x7BDE, 0x635E, 0x52DE, 0x4A9E, 0x425C, 0x3A1A, 0x3A18, 0x3198, 0x1916, 0x2114, 0x1112, 0x110C, 0x084A, 0x18C6, 0x0000,
    0x1084, 0x18CE, 0x20C4, 0x18D2, 0x18D6, 0x001A, 0x39DC, 0x39DE, 0x18CE, 0x18D2, 0x18D6, 0x109E, 0x319E, 0x39DE, 0x4A5E, 0x0000,
    0x6B9E, 0x7B54, 0x7250, 0x51CC, 0x001E, 0x001A, 0x7BDE, 0x52DE, 0x4A9E, 0x425C, 0x3A1A, 0x39D8, 0x3198, 0x1916, 0x2112, 0x110C,
    0x18C6, 0x2158, 0x18D4, 0x18D0, 0x10CC, 0x10CA, 0x39DC, 0x0018, 0x0000, 0x7BDE, 0x0000, 0x5AD6, 0x2108, 0x02DE, 0x019E, 0x0014,
    0x0000, 0x7BDE, 0x635E, 0x52DE, 0x4A9E, 0x425C, 0x3A1A, 0x3A18, 0x3198, 0x1916, 0x2114, 0x1112, 0x110C, 0x084A, 0x18C6, 0x6318,
    0x1084, 0x18CE, 0x20C4, 0x18D2, 0x18D6, 0x001A, 0x39DC, 0x39DE, 0x3106, 0x4186, 0x5A08, 0x624A, 0x6A8C, 0x72CE, 0x7310, 0x0000,
    0x6B9E, 0x7B54, 0x7250, 0x51CC, 0x001E, 0x001A, 0x7BDE, 0x52DE, 0x4A9E, 0x425C, 0x3A1A, 0x39D8, 0x3198, 0x1916, 0x2112, 0x110C,
    0x294A, 0x03DE, 0x0318, 0x0254, 0x01D0, 0x010A, 0x53DE, 0x0018, 0x0000, 0x7BDE, 0x0000, 0x5AD6, 0x2108, 0x02DE, 0x019E, 0x0014,
    0x0000, 0x635E, 0x52DC, 0x4A9C, 0x425C, 0x3A1A, 0x31D8, 0x2154, 0x190E, 0x18CA, 0x1088, 0x3A9E, 0x1A1A, 0x2192, 0x110E, 0x18C8,
    0x0844, 0x739C, 0x6B18, 0x62D6, 0x5A94, 0x5252, 0x4A10, 0x41CE, 0x398C, 0x314A, 0x1908, 0x18C6, 0x1084, 0x0842, 0x0000, 0x0000,
    0x0000, 0x395E, 0x109E, 0x0012, 0x4A5E, 0x6000, 0x78CC, 0x798C, 0x7BDE, 0x6B5A, 0x6318, 0x5AD6, 0x0018, 0x399E, 0x109E, 0x0014,
    0x18C6, 0x294A, 0x5294, 0x4A52, 0x4210, 0x39CE, 0x000C, 0x0252, 0x1B9C, 0x018C, 0x014A, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x635E, 0x52DC, 0x4A9C, 0x425C, 0x3A1A, 0x31D8, 0x2154, 0x190E, 0x18CA, 0x1088, 0x3A9C, 0x1A1A, 0x2192, 0x110E, 0x18C8,
    0x0844, 0x739C, 0x6B18, 0x62D6, 0x5A94, 0x5252, 0x4A10, 0x41CE, 0x398C, 0x314A, 0x2108, 0x18C6, 0x1084, 0x0842, 0x0000, 0x6B9E,
    0x7B54, 0x7250, 0x51CC, 0x4148, 0x421E, 0x319E, 0x295E, 0x00DE, 0x009A, 0x0056, 0x0012, 0x0010, 0x000C, 0x0008, 0x0000, 0x7BDE,
    0x6B5A, 0x5AD6, 0x5294, 0x4A52, 0x4210, 0x39CE, 0x318C, 0x7BDE, 0x001E, 0x0000, 0x5AD6, 0x4210, 0x2950, 0x0000, 0x0000, 0x0000,
};

static uint16_t x555_palette[] =
{
    0x0000, 0x5A92, 0x2218, 0x0194, 0x0110, 0x7A46, 0x7B50, 0x5982, 0x7986, 0x58C0, 0x4040, 0x62D4, 0x5250, 0x41CC, 0x3148, 0x0000,
    0x0000, 0x60C6, 0x5084, 0x4042, 0x3000, 0x6B58, 0x5294, 0x4210, 0x318C, 0x2108, 0x7108, 0x4800, 0x218E, 0x194A, 0x10C6, 0x7252,
    0x0000, RGB_x555(255,0,0), RGB_x555(0,255,0), RGB_x555(0,0,255),
                                    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, RGB_x555(150,20,20), RGB_x555(20,150,20), RGB_x555(150,20,150),
                                    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, RGB_x555(150,100,0), RGB_x555(20,150,20), RGB_x555(100,0,200),
                                    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    RGB_x555(0x0f,0x1b,0x26), RGB_x555(0xf5,0xe8,0xd1), RGB_x555(0x20,0xa5,0xa6), RGB_x555(0xdd,0x56,0x39),
                                    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, RGB_x555(0x0f,0x1b,0x26),
};

void set_default_palette()
{
    for( int base2 = 0; base2 < 4; base2++ )
    {
        int base = base2 << 6;

        set_palettes(base + 0, 8, x555_palette);
        
        set_gradient2(base + 8, 255, 255, 255, 10, 10, 10);
        set_gradient2(base + 9, 200, 0, 0, 10, 0, 0);
        set_gradient2(base + 10, 0, 200, 0, 0, 10, 0);
        set_gradient2(base + 11, 0, 0, 200, 0, 0, 10);
        
        set_gradient2(base + 12, 200, 0, 0, 100, 100, 100);
        set_gradient2(base + 13, 0, 200, 0, 100, 100, 100);
        set_gradient2(base + 14, 0, 0, 200, 100, 100, 100);
        set_gradient3(base + 15, 200, 0, 0, 0, 200, 0, 0, 0, 200);

        uint32_t test_colors[8] =
        {
            0xffe2ce,
            0xf56214,
            0xffc414,
            0x3bd827,
            0x147658,
            0x14c4ce,
            0x1d3162,
            0xa73176,
        };

        for( int x = 0; x < 8; x++ )
        {
            uint8_t r = (test_colors[x] >> 16) & 0xff;
            uint8_t g = (test_colors[x] >> 8) & 0xff;
            uint8_t b = (test_colors[x] >> 0) & 0xff;
            set_gradient2(base + 16 + x, 0, 0, 0, 0, 0, 0);
            set_gradient2(base + 32 + x, 0, 0, 0, 0, 0, 0);
            set_gradient3(base + 24 + x, r, g, b, 16, 16, 16, r, g, b);
        }
    }
}

